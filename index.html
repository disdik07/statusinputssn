<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Status Penginputan Data Interaktif</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bootstrap CSS for components & icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Chart.js & XLSX -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0d6efd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .spinning {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .card-custom {
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card-custom:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        .icon-circle {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Sidebar Styles */
        #sidebar {
            width: 280px;
            background: #ffffff;
            box-shadow: 2px 0 8px rgba(0,0,0,0.05);
            transition: margin-left 0.3s ease-in-out;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100;
        }
        #main-content {
            width: calc(100% - 280px);
            margin-left: 280px;
            transition: width 0.3s ease-in-out, margin-left 0.3s ease-in-out;
        }
        
        #sidebar.collapsed {
            margin-left: -280px;
        }
        #main-content.expanded {
            width: 100%;
            margin-left: 0;
        }
        
        /* Modal Styles */
        .modal-overlay {
            transition: opacity 0.3s ease;
            background-color: rgba(0,0,0,0.7);
        }
        .modal-container {
            transition: transform 0.3s ease;
        }
        
        .clickable-row:hover {
            background-color: #f1f3f5;
            cursor: pointer;
        }
        
        /* Mobile Bottom Nav */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        @media (max-width: 992px) { /* Changed breakpoint to lg */
            #sidebar {
                display: none !important;
            }
            #main-content {
                width: 100%;
                margin-left: 0;
            }
            #main-content.expanded { /* pastikan tetap 100% di mobile */
                 width: 100%;
                 margin-left: 0;
            }
        }
        
        @media (min-width: 992.02px) {
            .modal-overlay {
                left: 0; /* Selalu mulai dari kiri */
            }
             #main-content.expanded .modal-overlay {
                padding-left: 0;
            }
        }
        
        @media (max-width: 768px) {
             body {
                padding-bottom: 80px; /* Space for the bottom nav */
            }
        }
    </style>
</head>
<body class="text-gray-800">
    
    <!-- Sidebar -->
    <nav id="sidebar" class="d-none d-lg-flex flex-column p-4">
        <div class="sidebar-header d-flex justify-content-between align-items-center pb-4 mb-4 border-bottom">
            <h3 class="fw-bold fs-4 mb-0"><i class="bi bi-bar-chart-line-fill text-primary"></i> Dasbor Data</h3>
        </div>
        
        <!-- Kontrol dan Filter (Desktop) -->
        <div class="flex-grow-1">
             <div class="row g-3">
                <div class="col-12">
                    <label for="filter-tipe" class="form-label small fw-medium">Tipe Input</label>
                    <select id="filter-tipe" class="filter-input form-select">
                        <option value="Kuesioner">Kuesioner</option>
                        <option value="Data Dukung">Data Dukung</option>
                    </select>
                </div>
                <div class="col-12">
                    <label for="filter-jenjang" class="form-label small fw-medium">Jenjang</label>
                    <select id="filter-jenjang" class="filter-input form-select">
                        <option value="">Semua Jenjang</option>
                        <option value="SD">SD</option>
                        <option value="SMP">SMP</option>
                        <option value="PNF">PNF</option>
                    </select>
                </div>
                <div class="col-12">
                    <label for="filter-kecamatan" class="form-label small fw-medium">Kecamatan</label>
                    <select id="filter-kecamatan" class="filter-input form-select">
                        <option value="">Semua Kecamatan</option>
                    </select>
                </div>
                <div class="col-12">
                    <label for="filter-keterangan" class="form-label small fw-medium">Keterangan</label>
                    <select id="filter-keterangan" class="filter-input form-select">
                        <option value="">Semua Keterangan</option>
                        <option value="sudah">Sudah Mengisi</option>
                        <option value="belum">Belum Mengisi</option>
                    </select>
                </div>
                 <hr class="my-3">
                 <div class="col-12">
                     <label for="search-input" class="form-label small fw-medium">Pencarian</label>
                    <div class="position-relative">
                         <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary"></i>
                         <input type="text" id="search-input" placeholder="Cari sekolah atau NPSN..." class="form-control ps-5">
                    </div>
                </div>
            </div>
        </div>
        <div class="sidebar-footer border-top pt-3">
             <button id="sidebar-toggle-bottom" class="btn btn-outline-secondary w-100 d-flex align-items-center justify-content-center gap-2">
                <i class="bi bi-chevron-bar-left"></i>
                <span>Sembunyikan</span>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <div id="main-content">
        <div class="container-fluid p-4 md:p-5">
            <header class="d-flex justify-content-between align-items-center mb-5">
                <div class="d-flex align-items-center gap-3">
                    <button id="sidebar-toggle-main" class="btn btn-light d-none d-lg-block">
                        <i class="bi bi-list"></i>
                    </button>
                    <div>
                         <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-0">Progres Penginputan Data</h1>
                         <p class="text-secondary mt-1 small d-none d-md-block">Update real-time status penginputan data sekolah.</p>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <button id="refresh-btn" class="btn btn-outline-primary d-flex align-items-center gap-2">
                        <i class="bi bi-arrow-clockwise"></i>
                        <span class="d-none d-sm-inline">Refresh</span>
                    </button>
                    <button id="download-excel" class="btn btn-success d-flex align-items-center gap-2">
                        <i class="bi bi-file-earmark-excel"></i>
                        <span class="d-none d-sm-inline">Excel</span>
                    </button>
                    <button id="share-whatsapp" class="btn btn-info text-white d-flex align-items-center gap-2">
                        <i class="bi bi-whatsapp"></i>
                        <span class="d-none d-sm-inline">Share</span>
                    </button>
                </div>
            </header>

            <!-- Ringkasan Statistik (Clickable Cards) -->
            <div id="summary-section" class="row g-4 mb-5">
                <div class="col-md-4">
                    <div data-status-filter="semua" class="summary-card card-custom p-4 d-flex flex-row align-items-center gap-4 cursor-pointer">
                        <div class="icon-circle bg-primary bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-bank2 fs-4 text-primary"></i>
                        </div>
                        <div>
                            <p class="text-sm text-secondary mb-0">Total Sekolah</p>
                            <p id="total-sekolah" class="h4 fw-bold mb-0">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div data-status-filter="sudah" class="summary-card card-custom p-4 d-flex flex-row align-items-center gap-4 cursor-pointer">
                        <div class="icon-circle bg-success bg-opacity-10 p-3 rounded-circle">
                             <i class="bi bi-check-circle-fill fs-4 text-success"></i>
                        </div>
                        <div>
                            <p class="text-sm text-secondary mb-0">Sudah Mengisi</p>
                            <p id="sudah-mengisi" class="h4 fw-bold mb-0">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                     <div data-status-filter="belum" class="summary-card card-custom p-4 d-flex flex-row align-items-center gap-4 cursor-pointer">
                        <div class="icon-circle bg-danger bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-x-circle-fill fs-4 text-danger"></i>
                        </div>
                        <div>
                            <p class="text-sm text-secondary mb-0">Belum Mengisi</p>
                            <p id="belum-mengisi" class="h4 fw-bold mb-0">0</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ringkasan Responden -->
            <div class="row g-4 mb-5">
                <div class="col-6 col-md-3">
                    <div data-responden-filter="Pengawas" class="responden-card card-custom p-3 d-flex flex-row align-items-center gap-3 cursor-pointer">
                        <div class="icon-circle bg-info bg-opacity-10 rounded-circle">
                            <i class="bi bi-person-video3 fs-5 text-info"></i>
                        </div>
                        <div>
                            <p class="small text-secondary mb-0">Pengawas</p>
                            <p id="responden-pengawas" class="h5 fw-bold mb-0">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div data-responden-filter="Kepala Sekolah" class="responden-card card-custom p-3 d-flex flex-row align-items-center gap-3 cursor-pointer">
                        <div class="icon-circle bg-warning bg-opacity-10 rounded-circle">
                            <i class="bi bi-person-badge fs-5 text-warning"></i>
                        </div>
                        <div>
                            <p class="small text-secondary mb-0">Kepala Sekolah</p>
                            <p id="responden-kepsek" class="h5 fw-bold mb-0">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div data-responden-filter="Guru" class="responden-card card-custom p-3 d-flex flex-row align-items-center gap-3 cursor-pointer">
                        <div class="icon-circle bg-success bg-opacity-10 rounded-circle">
                            <i class="bi bi-people fs-5 text-success"></i>
                        </div>
                        <div>
                            <p class="small text-secondary mb-0">Guru</p>
                            <p id="responden-guru" class="h5 fw-bold mb-0">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div data-responden-filter="Komite Sekolah" class="responden-card card-custom p-3 d-flex flex-row align-items-center gap-3 cursor-pointer">
                        <div class="icon-circle bg-secondary bg-opacity-10 rounded-circle">
                            <i class="bi bi-person-workspace fs-5 text-secondary"></i>
                        </div>
                        <div>
                            <p class="small text-secondary mb-0">Komite Sekolah</p>
                            <p id="responden-komite" class="h5 fw-bold mb-0">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grafik -->
            <div class="row g-4 mb-5">
                <div class="col-lg-6">
                    <div class="card-custom p-4">
                        <h3 class="font-semibold mb-3 text-center">Data per Kecamatan</h3>
                        <div class="position-relative" style="height: 320px;">
                            <canvas id="kecamatanChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                     <div class="card-custom p-4">
                        <h3 class="font-semibold mb-3 text-center">Data per Jenjang</h3>
                        <div class="position-relative" style="height: 320px;">
                            <canvas id="jenjangChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tabel Data -->
            <div id="loader-container" class="d-flex justify-content-center align-items-center py-5 d-none">
                <div class="loader"></div>
            </div>
            <div id="data-container" class="card-custom overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th scope="col" class="px-3 py-3">NPSN</th>
                                <th scope="col" class="px-3 py-3">Nama Satuan Pendidikan</th>
                                <th scope="col" class="px-3 py-3">Jenjang</th>
                                <th scope="col" class="px-3 py-3">Status Sekolah</th>
                                <th scope="col" class="px-3 py-3">Kecamatan</th>
                                <th scope="col" class="px-3 py-3 text-center">Keterangan</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <!-- Isi tabel akan di-generate oleh JavaScript -->
                        </tbody>
                    </table>
                     <div id="no-data" class="d-none text-center py-5">
                        <p class="text-secondary fw-semibold">Data tidak ditemukan.</p>
                    </div>
                </div>
                <!-- Pagination -->
                <div id="pagination-controls" class="p-3 border-top d-flex justify-content-between align-items-center">
                     <!-- Kontrol paginasi akan di-generate oleh JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mobile Bottom Navigation -->
    <div id="mobile-controls" class="d-lg-none mobile-nav p-2 d-flex justify-content-around align-items-center">
        <button class="btn btn-light flex-fill" data-bs-toggle="modal" data-bs-target="#mobile-search-modal">
            <i class="bi bi-search"></i>
            <div><small>Cari</small></div>
        </button>
        <button class="btn btn-light flex-fill" data-bs-toggle="modal" data-bs-target="#mobile-filter-modal">
            <i class="bi bi-funnel"></i>
            <div><small>Filter</small></div>
        </button>
        <button class="btn btn-light flex-fill" id="mobile-download-excel">
            <i class="bi bi-file-earmark-excel"></i>
            <div><small>Excel</small></div>
        </button>
        <button class="btn btn-light flex-fill" id="mobile-share-whatsapp">
            <i class="bi bi-whatsapp"></i>
            <div><small>Share</small></div>
        </button>
    </div>

    <!-- Modal for Details -->
    <div id="detail-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-container bg-white w-full max-w-6xl rounded-xl shadow-lg max-h-[90vh] flex flex-col transform scale-95">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="modal-title" class="text-xl font-bold">Detail Data</h2>
                <button class="modal-close-btn text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-content" class="p-6 overflow-y-auto">
                <!-- Konten modal akan di-generate oleh JavaScript -->
            </div>
            <div id="modal-footer" class="p-4 border-t bg-gray-50 flex justify-end items-center gap-4 rounded-b-xl">
                 <button class="modal-close-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Tutup</button>
            </div>
        </div>
    </div>
    
    <!-- Mobile Modals -->
    <!-- Search Modal -->
    <div class="modal fade" id="mobile-search-modal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Cari Data</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="text" id="mobile-search-input" placeholder="Cari nama sekolah atau NPSN..." class="form-control">
          </div>
        </div>
      </div>
    </div>

    <!-- Filter Modal -->
    <div class="modal fade" id="mobile-filter-modal" tabindex="-1">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Filter Data</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
             <div class="mb-3">
                <label for="mobile-filter-tipe" class="form-label small fw-medium">Tipe Input</label>
                <select id="mobile-filter-tipe" class="filter-input-mobile form-select">
                    <option value="Kuesioner">Kuesioner</option>
                    <option value="Data Dukung">Data Dukung</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="mobile-filter-jenjang" class="form-label small fw-medium">Jenjang</label>
                <select id="mobile-filter-jenjang" class="filter-input-mobile form-select">
                    <option value="">Semua Jenjang</option>
                    <option value="SD">SD</option>
                    <option value="SMP">SMP</option>
                    <option value="PNF">PNF</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="mobile-filter-kecamatan" class="form-label small fw-medium">Kecamatan</label>
                <select id="mobile-filter-kecamatan" class="filter-input-mobile form-select">
                    <option value="">Semua Kecamatan</option>
                </select>
            </div>
            <div>
                <label for="mobile-filter-keterangan" class="form-label small fw-medium">Keterangan</label>
                <select id="mobile-filter-keterangan" class="filter-input-mobile form-select">
                    <option value="">Semua Keterangan</option>
                    <option value="sudah">Sudah Mengisi</option>
                    <option value="belum">Belum Mengisi</option>
                </select>
            </div>
          </div>
           <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="reset-filters-mobile">Reset</button>
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Terapkan</button>
          </div>
        </div>
      </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- KONFIGURASI ---
            const SPREADSHEET_ID = atob('MXhsVDZBRzkzTzlmOGxwSjJqbnlUOFVvMzhDYWV1NDVrck8tbG01T3Z1LVU=');
            const SHEET_CONFIG = JSON.parse(atob('eyJLdWVzaW9uZXIiOnsiUE5GIjoiMCIsIlNEIjoiMTM4MzQ0MjY0NSIsIlNNUCI6IjQ5NTQyMjI2NiJ9LCJEYXRhIER1a3VuZyI6eyJQTkYiOiIxODI1NjkxMzA4IiwiU0QiOiI2NDEyNzIwMyIsIlNNUCI6IjY4MDk3MTI2OSJ9fQ=='));
            const ROWS_PER_PAGE = 15;

            // --- ELEMEN DOM ---
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const sidebarToggleMainBtn = document.getElementById('sidebar-toggle-main');
            const sidebarToggleBottomBtn = document.getElementById('sidebar-toggle-bottom');
            
            const loader = document.getElementById('loader-container');
            const dataContainer = document.getElementById('data-container');
            const searchInput = document.getElementById('search-input');
            const mobileSearchInput = document.getElementById('mobile-search-input');
            const tableBody = document.getElementById('table-body');
            const noDataMessage = document.getElementById('no-data');
            
            const totalSekolahEl = document.getElementById('total-sekolah');
            const sudahMengisiEl = document.getElementById('sudah-mengisi');
            const belumMengisiEl = document.getElementById('belum-mengisi');

            const respondenPengawasEl = document.getElementById('responden-pengawas');
            const respondenKepsekEl = document.getElementById('responden-kepsek');
            const respondenGuruEl = document.getElementById('responden-guru');
            const respondenKomiteEl = document.getElementById('responden-komite');
            
            // Desktop Filters
            const desktopFilters = {
                tipe: document.getElementById('filter-tipe'),
                jenjang: document.getElementById('filter-jenjang'),
                kecamatan: document.getElementById('filter-kecamatan'),
                keterangan: document.getElementById('filter-keterangan')
            };

            // Mobile Filters
            const mobileFilters = {
                tipe: document.getElementById('mobile-filter-tipe'),
                jenjang: document.getElementById('mobile-filter-jenjang'),
                kecamatan: document.getElementById('mobile-filter-kecamatan'),
                keterangan: document.getElementById('mobile-filter-keterangan')
            };
            const resetFiltersMobileBtn = document.getElementById('reset-filters-mobile');


            const downloadExcelBtn = document.getElementById('download-excel');
            const shareWhatsappBtn = document.getElementById('share-whatsapp');
            const mobileDownloadExcelBtn = document.getElementById('mobile-download-excel');
            const mobileShareWhatsappBtn = document.getElementById('mobile-share-whatsapp');
            const paginationControls = document.getElementById('pagination-controls');
            const refreshBtn = document.getElementById('refresh-btn');

            const detailModal = document.getElementById('detail-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalFooter = document.getElementById('modal-footer');

            // --- STATE APLIKASI ---
            let rawDataCache = {};
            let allData = [];
            let filteredData = [];
            let currentPage = 1;
            let kecamatanChart, jenjangChart;

            const state = {
                tipe: 'Kuesioner',
                jenjang: '',
                kecamatan: '',
                keterangan: '',
                searchTerm: ''
            };
            
            // --- STATE MODAL ---
            let modalState = {
                data: [],
                filteredData: [],
                currentPage: 1,
                searchTerm: '',
                jenjang: '',
                kecamatan: ''
            };

            // --- FUNGSI UTAMA ---
            async function initializeApp() {
                // Muat data awal dan tampilkan
                await loadDataForTipe(state.tipe, true);
                allData = getCombinedDataForTipe(state.tipe);
                populateFilters();
                addEventListeners();
                applyFiltersAndRender();
                
                // Muat data lainnya di background
                preloadOtherDataTypes();
            }
            
            async function handleRefresh() {
                const icon = refreshBtn.querySelector('i');
                icon.classList.add('spinning');
                refreshBtn.disabled = true;

                rawDataCache = {}; // Hapus cache
                await loadDataForTipe(state.tipe, true); // Muat ulang data yang aktif
                allData = getCombinedDataForTipe(state.tipe);
                populateFilters();
                applyFiltersAndRender();
                preloadOtherDataTypes(); // Mulai ulang preload data background

                setTimeout(() => {
                    icon.classList.remove('spinning');
                    refreshBtn.disabled = false;
                }, 500);
            }

            async function loadDataForTipe(tipe, showLoaderFlag) {
                if(showLoaderFlag) showLoader(true);
                const jenjangs = ['SD', 'SMP', 'PNF'];
                let promises = [];

                for (const jenjang of jenjangs) {
                    const cacheKey = `${tipe}-${jenjang}`;
                    if (rawDataCache[cacheKey]) {
                        continue; // Data sudah ada di cache
                    }
                    const gid = SHEET_CONFIG[tipe]?.[jenjang];
                    if (gid || gid === "0") {
                        const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`;
                        promises.push(
                            fetch(url)
                                .then(response => {
                                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                                    return response.text();
                                })
                                .then(csvText => {
                                    const parsedData = parseCSV(csvText).map(row => ({...row, Jenjang: jenjang }));
                                    rawDataCache[cacheKey] = parsedData;
                                })
                                .catch(error => {
                                    console.error(`Gagal mengambil data untuk ${tipe} - ${jenjang}:`, error);
                                })
                        );
                    }
                }
                await Promise.all(promises);
                if(showLoaderFlag) showLoader(false);
            }
            
            function getCombinedDataForTipe(tipe) {
                const jenjangs = ['SD', 'SMP', 'PNF'];
                let combinedData = [];
                for(const jenjang of jenjangs) {
                    const cacheKey = `${tipe}-${jenjang}`;
                    if(rawDataCache[cacheKey]) {
                        combinedData.push(...rawDataCache[cacheKey]);
                    }
                }
                return combinedData;
            }

            async function preloadOtherDataTypes() {
                const allTipes = Object.keys(SHEET_CONFIG);
                for (const tipe of allTipes) {
                    if (tipe !== state.tipe) {
                       await loadDataForTipe(tipe, false); // Load in background
                    }
                }
            }
            
            function applyFiltersAndRender() {
                allData = getCombinedDataForTipe(state.tipe);
                
                filteredData = allData.filter(row => {
                    const status = (row['Keterangan'] || '').toLowerCase();
                    const isSudah = status.includes('sudah') || status.includes('selesai');
                    
                    const matchJenjang = !state.jenjang || row['Jenjang'] === state.jenjang;
                    const matchKecamatan = !state.kecamatan || (row['Kecamatan'] || '').toLowerCase() === state.kecamatan.toLowerCase();
                    const matchKeterangan = !state.keterangan || (state.keterangan === 'sudah' && isSudah) || (state.keterangan === 'belum' && !isSudah);
                    const matchSearch = !state.searchTerm || 
                                       (row['Nama Satuan Pendidikan'] || '').toLowerCase().includes(state.searchTerm) ||
                                       (row['NPSN'] || '').toLowerCase().includes(state.searchTerm);

                    return matchJenjang && matchKecamatan && matchKeterangan && matchSearch;
                });

                currentPage = 1;
                updateDashboard();
            }

            function updateDashboard() {
                updateSummaryCards();
                updateRespondentSummary();
                updateCharts();
                renderTable();
                updatePagination();
                syncFilterInputs();
            }

            // --- FUNGSI RENDER KOMPONEN ---

            function updateSummaryCards() {
                const total = filteredData.length;
                const sudah = filteredData.filter(row => {
                    const status = (row['Keterangan'] || '').toLowerCase();
                    return status.includes('sudah') || status.includes('selesai');
                }).length;
                const belum = total - sudah;

                totalSekolahEl.textContent = total;
                sudahMengisiEl.textContent = sudah;
                belumMengisiEl.textContent = belum;
            }
            
            function updateRespondentSummary() {
                const initialCounts = { pengawas: 0, kepsek: 0, guru: 0, komite: 0 };

                const counts = filteredData.reduce((acc, row) => {
                    acc.pengawas += parseInt(row['Pengawas']) || 0;
                    acc.kepsek += parseInt(row['Kepala Sekolah']) || 0;
                    acc.guru += parseInt(row['Guru']) || 0;
                    acc.komite += parseInt(row['Komite Sekolah']) || 0;
                    return acc;
                }, initialCounts);

                respondenPengawasEl.textContent = counts.pengawas;
                respondenKepsekEl.textContent = counts.kepsek;
                respondenGuruEl.textContent = counts.guru;
                respondenKomiteEl.textContent = counts.komite;
            }

            function renderTable() {
                if (filteredData.length === 0) {
                    tableBody.innerHTML = '';
                    noDataMessage.classList.remove('d-none');
                    return;
                }

                noDataMessage.classList.add('d-none');
                const startIndex = (currentPage - 1) * ROWS_PER_PAGE;
                const endIndex = startIndex + ROWS_PER_PAGE;
                const pageData = filteredData.slice(startIndex, endIndex);

                tableBody.innerHTML = pageData.map((row, index) => {
                    const status = (row['Keterangan'] || '').toLowerCase();
                    const isFilled = status.includes('sudah') || status.includes('selesai');
                    const badgeClass = isFilled ? 'bg-success-subtle text-success-emphasis' : 'bg-danger-subtle text-danger-emphasis';
                    
                    return `
                        <tr class="clickable-row" data-index="${startIndex + index}">
                            <td class="px-3 py-3">${row['NPSN'] || ''}</td>
                            <td class="px-3 py-3">${row['Nama Satuan Pendidikan'] || ''}</td>
                            <td class="px-3 py-3">${row['Jenjang'] || ''}</td>
                            <td class="px-3 py-3">${row['Status Sekolah'] || ''}</td>
                            <td class="px-3 py-3">${row['Kecamatan'] || ''}</td>
                            <td class="px-3 py-3 text-center"><span class="badge rounded-pill ${badgeClass}">${row['Keterangan'] || 'Belum'}</span></td>
                        </tr>
                    `;
                }).join('');
            }

            function updatePagination() {
                const totalPages = Math.ceil(filteredData.length / ROWS_PER_PAGE);
                paginationControls.innerHTML = '';
                if (totalPages <= 1) return;

                let paginationHTML = `<span class="text-sm text-secondary">Halaman ${currentPage} dari ${totalPages}</span>`;
                let buttonsHTML = '<div class="btn-group btn-group-sm">';
                
                buttonsHTML += `<button data-page="${currentPage - 1}" class="pagination-btn btn btn-outline-secondary" ${currentPage === 1 ? 'disabled' : ''}>Sebelumnya</button>`;
                buttonsHTML += `<button data-page="${currentPage + 1}" class="pagination-btn btn btn-outline-secondary" ${currentPage === totalPages ? 'disabled' : ''}>Berikutnya</button>`;

                buttonsHTML += '</div>';
                paginationControls.innerHTML = paginationHTML + buttonsHTML;
            }
            
            Chart.defaults.font.family = 'Poppins';

            function updateCharts() {
                // Data per Kecamatan
                const kecamatanData = filteredData.reduce((acc, row) => {
                    const kecamatan = row['Kecamatan'] || 'Tidak Diketahui';
                    if (!acc[kecamatan]) {
                        acc[kecamatan] = { sudah: 0, belum: 0 };
                    }
                    const status = (row['Keterangan'] || '').toLowerCase();
                    const isSudah = status.includes('sudah') || status.includes('selesai');
                    if (isSudah) acc[kecamatan].sudah++;
                    else acc[kecamatan].belum++;
                    return acc;
                }, {});

                const kecamatanLabels = Object.keys(kecamatanData);
                const kecamatanSudah = kecamatanLabels.map(k => kecamatanData[k].sudah);
                const kecamatanBelum = kecamatanLabels.map(k => kecamatanData[k].belum);

                if (kecamatanChart) kecamatanChart.destroy();
                kecamatanChart = new Chart(document.getElementById('kecamatanChart'), {
                    type: 'bar',
                    data: {
                        labels: kecamatanLabels,
                        datasets: [
                            { label: 'Sudah', data: kecamatanSudah, backgroundColor: 'rgba(25, 135, 84, 0.7)' },
                            { label: 'Belum', data: kecamatanBelum, backgroundColor: 'rgba(220, 53, 69, 0.7)' }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
                });

                // Data per Jenjang
                const jenjangData = filteredData.reduce((acc, row) => {
                    const jenjang = row['Jenjang'] || 'Tidak Diketahui';
                     if (!acc[jenjang]) {
                        acc[jenjang] = { sudah: 0, belum: 0 };
                    }
                    const status = (row['Keterangan'] || '').toLowerCase();
                    const isSudah = status.includes('sudah') || status.includes('selesai');
                    if (isSudah) acc[jenjang].sudah++;
                    else acc[jenjang].belum++;
                    return acc;
                }, {});
                
                const jenjangLabels = Object.keys(jenjangData);
                const jenjangSudah = jenjangLabels.map(j => jenjangData[j].sudah);
                const jenjangBelum = jenjangLabels.map(j => jenjangData[j].belum);

                if (jenjangChart) jenjangChart.destroy();
                jenjangChart = new Chart(document.getElementById('jenjangChart'), {
                    type: 'doughnut',
                    data: {
                        labels: jenjangLabels,
                        datasets: [{
                            label: 'Jumlah Sekolah',
                            data: jenjangLabels.map(j => jenjangData[j].sudah + jenjangData[j].belum),
                            backgroundColor: ['rgba(13, 110, 253, 0.7)', 'rgba(255, 193, 7, 0.7)', 'rgba(111, 66, 193, 0.7)'],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                     options: { responsive: true, maintainAspectRatio: false, cutout: '60%' }
                });
            }


            // --- FUNGSI MODAL ---
            function openCardModal(data, title) {
                // Implementasi modal ini menggunakan Tailwind, bukan Bootstrap modal.
                // Jika ingin konsisten, bisa diubah ke Bootstrap modal.
                modalState = {
                    data: data,
                    filteredData: data,
                    currentPage: 1,
                    searchTerm: '',
                    jenjang: '',
                    kecamatan: ''
                };
                modalTitle.textContent = title;
                renderModalContent();
                openModal();
            }

            function applyModalFiltersAndRender() {
                modalState.filteredData = modalState.data.filter(row => {
                    const matchJenjang = !modalState.jenjang || row['Jenjang'] === modalState.jenjang;
                    const matchKecamatan = !modalState.kecamatan || (row['Kecamatan'] || '').toLowerCase() === modalState.kecamatan.toLowerCase();
                    const matchSearch = !modalState.searchTerm || 
                                       (row['Nama Satuan Pendidikan'] || '').toLowerCase().includes(modalState.searchTerm) ||
                                       (row['NPSN'] || '').toLowerCase().includes(modalState.searchTerm);
                    return matchJenjang && matchKecamatan && matchSearch;
                });
                modalState.currentPage = 1;
                renderModalContent();
            }

            function renderModalContent() {
                // Build Controls
                const kecamatans = [...new Set(modalState.data.map(row => row['Kecamatan']).filter(Boolean))].sort();
                const jenjangs = [...new Set(modalState.data.map(row => row['Jenjang']).filter(Boolean))].sort();

                let controlsHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 p-4 border rounded-lg bg-gray-50">
                        <input type="text" id="modal-search" placeholder="Cari di dalam pop-up..." class="md:col-span-2 w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="modal-filter-jenjang" class="w-full border border-gray-300 rounded-lg px-4 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Semua Jenjang</option>
                            ${jenjangs.map(j => `<option value="${j}">${j}</option>`).join('')}
                        </select>
                        <select id="modal-filter-kecamatan" class="w-full border border-gray-300 rounded-lg px-4 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Semua Kecamatan</option>
                            ${kecamatans.map(k => `<option value="${k}">${k}</option>`).join('')}
                        </select>
                    </div>
                `;

                // Build Table
                const startIndex = (modalState.currentPage - 1) * ROWS_PER_PAGE;
                const endIndex = startIndex + ROWS_PER_PAGE;
                const pageData = modalState.filteredData.slice(startIndex, endIndex);

                let tableHTML = '<p class="text-center text-gray-500 py-8">Tidak ada data untuk ditampilkan.</p>';
                if (pageData.length > 0) {
                    tableHTML = `
                        <div class="overflow-x-auto border rounded-lg">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-3 text-left font-semibold">NPSN</th>
                                        <th class="p-3 text-left font-semibold">Nama Satuan Pendidikan</th>
                                        <th class="p-3 text-left font-semibold">Kecamatan</th>
                                        <th class="p-3 text-left font-semibold">Keterangan</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pageData.map(row => `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="p-3">${row['NPSN']}</td>
                                            <td class="p-3">${row['Nama Satuan Pendidikan']}</td>
                                            <td class="p-3">${row['Kecamatan']}</td>
                                            <td class="p-3">${row['Keterangan']}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                // Build Pagination
                const totalPages = Math.ceil(modalState.filteredData.length / ROWS_PER_PAGE);
                let paginationHTML = '';
                if (totalPages > 1) {
                    paginationHTML = `
                        <div class="mt-4 flex justify-between items-center">
                            <span class="text-sm text-gray-700">Halaman ${modalState.currentPage} dari ${totalPages}</span>
                            <div class="flex items-center gap-2">
                                <button data-page="${modalState.currentPage - 1}" class="modal-pagination-btn" ${modalState.currentPage === 1 ? 'disabled' : ''}>Sebelumnya</button>
                                <button data-page="${modalState.currentPage + 1}" class="modal-pagination-btn" ${modalState.currentPage === totalPages ? 'disabled' : ''}>Berikutnya</button>
                            </div>
                        </div>
                    `;
                }
                
                modalContent.innerHTML = controlsHTML + tableHTML + paginationHTML;

                // Add Download Button to Footer
                modalFooter.innerHTML = `
                    <button id="modal-download-excel" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        Unduh Excel
                    </button>
                    <button class="modal-close-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Tutup</button>
                `;

                // Add event listeners for modal controls
                addModalEventListeners();
            }

            function addModalEventListeners() {
                // Search
                const modalSearch = document.getElementById('modal-search');
                if(modalSearch) {
                    modalSearch.value = modalState.searchTerm;
                    modalSearch.addEventListener('input', (e) => {
                        modalState.searchTerm = e.target.value.toLowerCase();
                        applyModalFiltersAndRender();
                    });
                }

                // Filters
                const modalFilterJenjang = document.getElementById('modal-filter-jenjang');
                if(modalFilterJenjang) {
                    modalFilterJenjang.value = modalState.jenjang;
                    modalFilterJenjang.addEventListener('change', (e) => {
                        modalState.jenjang = e.target.value;
                        applyModalFiltersAndRender();
                    });
                }
                const modalFilterKecamatan = document.getElementById('modal-filter-kecamatan');
                if(modalFilterKecamatan) {
                    modalFilterKecamatan.value = modalState.kecamatan;
                    modalFilterKecamatan.addEventListener('change', (e) => {
                        modalState.kecamatan = e.target.value;
                        applyModalFiltersAndRender();
                    });
                }
                
                // Pagination
                document.querySelectorAll('.modal-pagination-btn').forEach(btn => {
                    btn.classList.add('px-4', 'py-2', 'text-sm', 'font-medium', 'text-gray-700', 'bg-white', 'border', 'border-gray-300', 'rounded-md', 'hover:bg-gray-50', 'disabled:opacity-50', 'disabled:cursor-not-allowed');
                    btn.addEventListener('click', (e) => {
                        modalState.currentPage = parseInt(e.target.dataset.page);
                        renderModalContent();
                    });
                });

                // Excel Download
                const modalDownloadBtn = document.getElementById('modal-download-excel');
                if(modalDownloadBtn) {
                    modalDownloadBtn.addEventListener('click', () => {
                        const worksheet = XLSX.utils.json_to_sheet(modalState.filteredData);
                        const workbook = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(workbook, worksheet, "Data Detail");
                        XLSX.writeFile(workbook, `Laporan_Detail_${modalTitle.textContent}.xlsx`);
                    });
                }
            }


            // --- FUNGSI PEMBANTU ---

            function populateFilters() {
                const kecamatans = [...new Set(allData.map(row => row['Kecamatan']).filter(Boolean))].sort();
                
                // Populate desktop and mobile filters
                [desktopFilters.kecamatan, mobileFilters.kecamatan].forEach(select => {
                    const currentVal = select.value;
                    select.innerHTML = '<option value="">Semua Kecamatan</option>';
                    kecamatans.forEach(k => {
                        const option = document.createElement('option');
                        option.value = k.toLowerCase(); // Use lowercase for value consistency
                        option.textContent = k;
                        select.appendChild(option);
                    });
                    select.value = currentVal;
                });
            }

            function parseCSV(text) {
                const lines = text.trim().split('\n');
                if (lines.length < 2) return [];
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                return lines.slice(1).map(line => {
                    const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ''));
                    let obj = {};
                    headers.forEach((header, i) => { obj[header] = values[i] || ''; });
                    return obj;
                });
            }
            
            function showLoader(isLoading) {
                if (isLoading) {
                    loader.classList.remove('d-none');
                    dataContainer.classList.add('d-none');
                } else {
                    loader.classList.add('d-none');
                    dataContainer.classList.remove('d-none');
                }
            }
            
            function openModal() {
                detailModal.classList.remove('opacity-0', 'pointer-events-none');
                detailModal.querySelector('.modal-container').classList.remove('scale-95');
                
                const isSidebarVisible = !sidebar.classList.contains('collapsed');
                if (window.innerWidth > 992 && isSidebarVisible) {
                    detailModal.style.paddingLeft = '280px';
                } else {
                    detailModal.style.paddingLeft = '0px';
                }
            }

            function closeModal() {
                detailModal.classList.add('opacity-0', 'pointer-events-none');
                detailModal.querySelector('.modal-container').classList.add('scale-95');
            }
            
            function syncFilterInputs() {
                // Sync desktop and mobile filters to match the current state
                for (const key in state) {
                    if (desktopFilters[key]) desktopFilters[key].value = state[key];
                    if (mobileFilters[key]) mobileFilters[key].value = state[key];
                }
                 mobileSearchInput.value = state.searchTerm;
                 searchInput.value = state.searchTerm;
            }

            // --- EVENT LISTENERS ---

            function addEventListeners() {
                // Sidebar Toggle
                const toggleSidebar = () => {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('expanded');

                    const buttonText = sidebarToggleBottomBtn.querySelector('span');
                    const buttonIcon = sidebarToggleBottomBtn.querySelector('i');
                    if (sidebar.classList.contains('collapsed')) {
                        buttonText.textContent = 'Tampilkan';
                        buttonIcon.classList.replace('bi-chevron-bar-left', 'bi-chevron-bar-right');
                    } else {
                        buttonText.textContent = 'Sembunyikan';
                        buttonIcon.classList.replace('bi-chevron-bar-right', 'bi-chevron-bar-left');
                    }
                    
                    // Re-render chart after transition to fix resizing issue
                    setTimeout(() => {
                        if (kecamatanChart) kecamatanChart.resize();
                        if (jenjangChart) jenjangChart.resize();
                    }, 300);
                };
                sidebarToggleMainBtn.addEventListener('click', toggleSidebar);
                sidebarToggleBottomBtn.addEventListener('click', toggleSidebar);

                 // Desktop Filters
                for (const key in desktopFilters) {
                    desktopFilters[key].addEventListener('change', async (e) => {
                        state[key] = e.target.value;
                         if (key === 'tipe') {
                           showLoader(true);
                           // Check if data is already in cache
                           const isCached = getCombinedDataForTipe(state.tipe).length > 0;
                           if (!isCached) {
                               await loadDataForTipe(state.tipe, false);
                           }
                           // Re-populate filters and re-render with new data source
                           allData = getCombinedDataForTipe(state.tipe);
                           populateFilters();
                           applyFiltersAndRender();
                           showLoader(false);
                       } else {
                           applyFiltersAndRender();
                       }
                    });
                }
                 // Mobile Filters
                for (const key in mobileFilters) {
                    mobileFilters[key].addEventListener('change', async (e) => {
                         state[key] = e.target.value;
                         if (key === 'tipe') {
                           // For mobile, we just update state, render happens on modal close
                           const isCached = getCombinedDataForTipe(state.tipe).length > 0;
                           if (!isCached) {
                               const filterModal = bootstrap.Modal.getInstance(document.getElementById('mobile-filter-modal'));
                               filterModal.hide();
                               await loadDataForTipe(state.tipe, true);
                           }
                        }
                    });
                }
                
                // Apply mobile filters when modal is closed
                 document.getElementById('mobile-filter-modal').addEventListener('hidden.bs.modal', () => {
                    applyFiltersAndRender();
                });


                resetFiltersMobileBtn.addEventListener('click', () => {
                    state.jenjang = '';
                    state.kecamatan = '';
                    state.keterangan = '';
                    // Tipe and search term are not reset
                    syncFilterInputs(); 
                });
                
                searchInput.addEventListener('input', (e) => {
                    state.searchTerm = e.target.value.toLowerCase();
                    applyFiltersAndRender();
                });
                
                mobileSearchInput.addEventListener('input', (e) => {
                    state.searchTerm = e.target.value.toLowerCase();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('mobile-search-modal'));
                    modal.hide();
                    applyFiltersAndRender();
                });

                paginationControls.addEventListener('click', (e) => {
                    if (e.target.matches('.pagination-btn')) {
                        currentPage = parseInt(e.target.dataset.page);
                        renderTable();
                        updatePagination();
                    }
                });
                
                tableBody.addEventListener('click', (e) => {
                    const row = e.target.closest('tr');
                    if (!row) return;
                    const dataIndex = row.dataset.index;
                    const schoolData = filteredData[dataIndex];
                    if (!schoolData) return;
                    
                    modalTitle.textContent = schoolData['Nama Satuan Pendidikan'];
                    let contentHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">';
                    for (const key in schoolData) {
                        contentHTML += `
                            <div>
                                <p class="font-semibold text-gray-500">${key}</p>
                                <p>${schoolData[key] || '-'}</p>
                            </div>
                        `;
                    }
                    contentHTML += '</div>';
                    modalContent.innerHTML = contentHTML;
                    modalFooter.innerHTML = `<button class="modal-close-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Tutup</button>`;
                    openModal();
                });
                
                document.querySelectorAll('.summary-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const statusFilter = e.currentTarget.dataset.statusFilter;
                        const dataToShow = filteredData.filter(row => {
                           if (statusFilter === 'semua') return true;
                           const status = (row['Keterangan'] || '').toLowerCase();
                           const isSudah = status.includes('sudah') || status.includes('selesai');
                           return (statusFilter === 'sudah' && isSudah) || (statusFilter === 'belum' && !isSudah);
                        });
                        
                        const title = `Daftar Sekolah (${statusFilter.charAt(0).toUpperCase() + statusFilter.slice(1)})`;
                        openCardModal(dataToShow, title);
                    });
                });
                
                document.querySelectorAll('.responden-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const respondenFilter = e.currentTarget.dataset.respondenFilter;
                        const dataToShow = filteredData.filter(row => {
                           return (parseInt(row[respondenFilter]) || 0) > 0;
                        });
                        
                        const title = `Daftar Sekolah (Responden: ${respondenFilter})`;
                        openCardModal(dataToShow, title);
                    });
                });

                detailModal.addEventListener('click', (e) => {
                    if (e.target.matches('.modal-overlay') || e.target.matches('.modal-close-btn') || e.target.closest('.modal-close-btn')) {
                        closeModal();
                    }
                });
                
                const handleDownload = () => {
                    const worksheet = XLSX.utils.json_to_sheet(filteredData);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Data");
                    XLSX.writeFile(workbook, "Laporan_Status_Penginputan.xlsx");
                };

                const handleShare = () => {
                    const total = totalSekolahEl.textContent;
                    const sudah = sudahMengisiEl.textContent;
                    const belum = belumMengisiEl.textContent;
                    let summary = `*Ringkasan Status Penginputan Data*\n\n`;
                    summary += `Tipe: ${state.tipe}\n`;
                    summary += `Total Sekolah: ${total}\n`;
                    summary += `Sudah Mengisi: ${sudah}\n`;
                    summary += `Belum Mengisi: ${belum}\n\n`;
                    summary += `*Filter Aktif:*\n`;
                    summary += `Jenjang: ${state.jenjang || 'Semua'}\n`;
                    summary += `Kecamatan: ${state.kecamatan ? desktopFilters.kecamatan.options[desktopFilters.kecamatan.selectedIndex].text : 'Semua'}\n`;
                    summary += `Keterangan: ${state.keterangan || 'Semua'}\n`;

                    const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(summary)}`;
                    window.open(whatsappUrl, '_blank');
                };

                downloadExcelBtn.addEventListener('click', handleDownload);
                mobileDownloadExcelBtn.addEventListener('click', handleDownload);
                shareWhatsappBtn.addEventListener('click', handleShare);
                mobileShareWhatsappBtn.addEventListener('click', handleShare);
                refreshBtn.addEventListener('click', handleRefresh);
            }

            // --- INISIALISASI APLIKASI ---
            initializeApp();
        });
    </script>
</body>
</html>

